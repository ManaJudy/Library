<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Étendre un Prêt - Bibliothèque</title>
    <link rel="stylesheet" href="/css/modern-style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
<div class="container">
    <div class="card">
        <div class="header">
            <h1>⏳ Étendre un Prêt</h1>
            <p>Prolongez la durée d'un prêt en cours</p>
        </div>

        <form id="extendForm">
            <div class="form-group">
                <label for="memberId">👤 Membre</label>
                <select id="memberId" name="memberId" class="form-control" required>
                    <option value="">Sélectionnez un membre...</option>
                </select>
            </div>

            <div class="form-group">
                <label for="bookId">📚 Livre</label>
                <select id="bookId" name="bookId" class="form-control" required>
                    <option value="">Sélectionnez un livre...</option>
                </select>
            </div>

            <button type="submit" class="btn btn-success" id="submitBtn">
                <span class="loading" id="loadingSpinner" style="display: none;">
                    <span class="spinner"></span>
                    Traitement en cours...
                </span>
                <span id="submitText">Étendre le Prêt</span>
            </button>
        </form>
    </div>

    <div id="message" class="alert"></div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        loadMembers();

        document.getElementById('memberId').addEventListener('change', function () {
            const memberId = this.value;
            if (memberId) {
                loadBooksOfMember(memberId);
            } else {
                resetSelect('bookId', 'Sélectionnez un livre...');
            }
        });

        document.getElementById('extendForm').addEventListener('submit', function (e) {
            e.preventDefault();
            extendLoan();
        });
    });

    async function loadMembers() {
        try {
            const response = await fetch('/api/members');
            const members = await response.json();
            const select = document.getElementById('memberId');

            members.forEach(member => {
                const option = document.createElement('option');
                option.value = member.id;
                option.textContent = `${member.firstName} ${member.lastName}`;
                select.appendChild(option);
            });
        } catch (error) {
            console.error('Erreur lors du chargement des membres:', error);
            showMessage('Erreur lors du chargement des membres', 'error');
        }
    }

    async function loadBooksOfMember(memberId) {
        try {
            const response = await fetch(`/api/loans/of-member/${memberId}`);
            const loans = await response.json();
            const select = document.getElementById('bookId');
            resetSelect('bookId', 'Sélectionnez un livre...');

            loans.forEach(loan => {
                const book = loan.copy.book;
                const option = document.createElement('option');
                option.value = loan.id;
                option.textContent = `${book.title} - ${book.author}`;
                select.appendChild(option);
            });
        } catch (error) {
            console.error('Erreur lors du chargement des prêts du membre:', error);
            showMessage('Erreur lors du chargement des livres', 'error');
        }
    }

    async function extendLoan() {
        const submitBtn = document.getElementById('submitBtn');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const submitText = document.getElementById('submitText');

        const memberId = document.getElementById('memberId').value;
        const loanId = document.getElementById('bookId').value;

        if (!memberId || !loanId) {
            showMessage('Veuillez remplir tous les champs', 'error');
            return;
        }

        submitBtn.disabled = true;
        loadingSpinner.style.display = 'flex';
        submitText.style.display = 'none';

        try {
            const response = await fetch(`/api/loans/extend`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ id: loanId })
            });

            if (response.ok) {
                await response.json();
                showMessage('Prêt étendu avec succès!', 'success');
                document.getElementById('extendForm').reset();
                resetSelect('bookId', 'Sélectionnez un livre...');
            } else {
                const error = await response.text();
                showMessage('Erreur lors de l\'extension du prêt: ' + error, 'error');
            }
        } catch (error) {
            console.error('Erreur:', error);
            showMessage('Erreur lors de l\'extension du prêt', 'error');
        } finally {
            submitBtn.disabled = false;
            loadingSpinner.style.display = 'none';
            submitText.style.display = 'inline';
        }
    }

    function resetSelect(selectId, defaultText) {
        const select = document.getElementById(selectId);
        select.innerHTML = '';
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = defaultText;
        select.appendChild(defaultOption);
    }

    function showMessage(text, type) {
        const messageDiv = document.getElementById('message');
        messageDiv.textContent = text;
        messageDiv.className = `alert alert-${type} show`;
        setTimeout(() => {
            messageDiv.classList.remove('show');
        }, 5000);
    }
</script>
</body>
</html>

